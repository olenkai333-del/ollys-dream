<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Olly's Dream</title>
<style>
  :root{
    --bg:#ffe4ee;
    --card:#fff;
    --ink:#222;
    --ink-2:#555;
    --muted:#8a8a8a;
    --pill:#ffd0dd;
    --brand:#f06292;
    --brand-2:#ff5ca8;
    --ok:#1b9e77;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:-apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink)}
  .wrap{max-width:900px;margin:0 auto;padding:28px 16px 80px}
  h1{margin:0 0 10px;font-size:36px}
  .muted{color:var(--muted)}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 18px}
  .btn{background:#fff;border:0;border-radius:999px;padding:10px 16px;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.06);cursor:pointer}
  .btn.brand{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
  .tab{border-radius:999px;padding:12px 18px;border:0;background:#fff;font-weight:700;cursor:pointer}
  .tab.active{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff}
  .search{width:100%;padding:14px 16px;border-radius:12px;border:0;box-shadow:0 1px 0 rgba(0,0,0,.1);margin-bottom:10px}
  .stats{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 16px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:#fff;padding:10px 14px;border-radius:999px;font-weight:700}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border-radius:20px;padding:14px 14px 6px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
  .row{display:flex;gap:12px}
  .thumb{width:82px;height:82px;border-radius:12px;object-fit:cover;background:#f3f3f3;flex:0 0 auto}
  .title{font-weight:800;font-size:22px;margin:2px 0 2px;cursor:pointer;text-decoration:underline;text-decoration-thickness:2px}
  .sub{color:var(--ink-2);margin:0 0 6px}
  .pill{display:inline-block;background:var(--pill);padding:8px 14px;border-radius:999px;font-weight:700}
  .card-actions{display:flex;justify-content:flex-end;border-top:1px solid #f1f1f1;margin-top:8px;padding:10px 6px 8px}
  .link{color:var(--brand-2);font-weight:700;cursor:pointer}
  dialog{border:0;border-radius:18px;max-width:620px;width:92vw;padding:0;box-shadow:0 20px 80px rgba(0,0,0,.36)}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .modal{padding:18px}
  .modal h3{margin:0 0 12px}
  .form{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:560px){.form{grid-template-columns:1fr 1fr}}
  label{font-size:13px;color:var(--ink-2);font-weight:700}
  input[type="text"],input[type="number"],textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid #e7e7e7}
  textarea{min-height:96px;grid-column:1/-1}
  .file{grid-column:1/-1}
  .preview{width:110px;height:110px;border-radius:12px;object-fit:cover;background:#f3f3f3}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .danger{background:#fff1f2;color:#d10c3f;border:1px solid #ffd6de}
  small.help{display:block;color:var(--muted);margin-top:4px}
  .readonly .input{opacity:.75}
  .readonly .modal-actions .btn.brand{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Olly's Dream</h1>
    <div class="muted">Ткани · Выкройки · Готовые изделия — офлайн, с сохранением</div>

    <div class="toolbar">
      <button class="btn" id="exportJson">Экспорт JSON</button>
      <button class="btn" id="importJson">Импорт JSON</button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="fabrics">Ткани</button>
      <button class="tab" data-tab="patterns">Выкройки</button>
      <button class="tab" data-tab="products">Готовые изделия</button>
      <button class="btn brand" style="margin-left:auto" id="addFabric">+ Добавить ткань</button>
    </div>

    <input class="search" id="search" placeholder="Поиск по названию, тегам, заметке…">
    <div class="stats">
      <div class="chip">Всего: <span id="totalLen" style="margin-left:6px">0 м</span></div>
      <div class="chip">Списано: <span id="spentLen" style="margin-left:6px">0 м</span></div>
    </div>

    <div class="grid" id="list"></div>
    <div class="muted" style="margin-top:14px">Данные сохраняются локально в браузере (localStorage). Для резервной копии используйте «Экспорт JSON».</div>
  </div>

  <dialog id="fabricDialog">
    <div class="modal">
      <h3 id="dlgTitle">Добавить ткань</h3>
      <div class="form" id="fabricForm">
        <div class="input">
          <label>Название</label>
          <input type="text" id="f_name" placeholder="Напр., Кулирка">
        </div>
        <div class="input">
          <label>Тип</label>
          <select id="f_type">
            <option>Хлопок</option><option>Лён</option><option>Шёлк</option><option>Шерсть</option><option>Синтетика</option>
          </select>
        </div>
        <div class="input">
          <label>Количество (метры)</label>
          <input type="number" id="f_qty" min="0" step="0.1" placeholder="0">
        </div>
        <div class="input">
          <label>Теги (через запятую)</label>
          <input type="text" id="f_tags" placeholder="розовый, детское, 150см">
        </div>
        <div class="input" style="grid-column:1/-1">
          <label>Заметка</label>
          <textarea id="f_note" placeholder="Особенности, где хранится и т. п."></textarea>
        </div>
        <div class="file">
          <label>Фото ткани (необязательно)</label><br>
          <img id="f_preview" class="preview" alt="">
          <input type="file" id="f_photo" accept="image/*">
          <small class="help">Фото сожмётся для экономии места.</small>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn danger" id="deleteBtn" style="margin-right:auto;display:none">Удалить</button>
        <button class="btn" id="cancelBtn">Отмена</button>
        <button class="btn brand" id="saveBtn">Сохранить</button>
      </div>
    </div>
  </dialog>

<script>
const KEY='od_fabrics_v1';
const $=sel=>document.querySelector(sel);
const listEl = $("#list");
const dlg = $("#fabricDialog");
const fName=$("#f_name"), fType=$("#f_type"), fQty=$("#f_qty"), fTags=$("#f_tags"), fNote=$("#f_note"), fPhoto=$("#f_photo"), fPrev=$("#f_preview");
const dlgTitle=$("#dlgTitle"), delBtn=$("#deleteBtn"), saveBtn=$("#saveBtn");

let state = {
  tab: 'fabrics',
  editId: null,
  items: load()
};

function load(){
  try{ return JSON.parse(localStorage.getItem(KEY))||[] }catch{ return [] }
}
function persist(){ localStorage.setItem(KEY, JSON.stringify(state.items)) }

function human(n){ return (Number(n)||0).toLocaleString('ru-RU',{maximumFractionDigits:2}) + ' м' }

function calc(){
  const total = state.items.reduce((s,i)=>s+(Number(i.qty)||0),0);
  $("#totalLen").textContent = human(total);
  $("#spentLen").textContent = human(0);
}

function resizeImage(file, max=1024){
  return new Promise((resolve,reject)=>{
    if(!file) return resolve(null);
    const img=new Image(); const r=new FileReader();
    r.onload=e=>{ img.onload=()=>{
      const scale = Math.min(1, max/Math.max(img.width,img.height));
      const canvas=document.createElement('canvas');
      canvas.width=Math.round(img.width*scale); canvas.height=Math.round(img.height*scale);
      const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height);
      resolve(canvas.toDataURL('image/jpeg',0.85));
    }; img.src=e.target.result };
    r.onerror=reject; r.readAsDataURL(file);
  });
}

function cardTemplate(it, idx){
  const noteText = it.note && it.note.trim() ? it.note.trim() : '—';
  const tags = (it.tags||[]).slice(0,3).map(t=>`<span class="pill">${t}</span>`).join(' ');
  return `<div class="card" data-idx="${idx}">
    <div class="row">
      <img class="thumb" src="${it.photo||''}" alt="">
      <div style="flex:1 1 auto">
        <div class="title" data-action="view">${it.name||'Без названия'}</div>
        <div class="sub">${noteText}</div>
        <div class="sub">Кол-во: <b>${human(it.qty||0).replace(' м','')}</b></div>
        ${tags?`<div style="margin:8px 0 6px">${tags}</div>`:''}
      </div>
    </div>
    <div class="card-actions">
      <span class="link" data-action="edit">Изменить</span>
    </div>
  </div>`;
}

function render(){
  const q = $("#search").value.trim().toLowerCase();
  const items = state.items.filter(it=>{
    const hay = [it.name, it.type, (it.tags||[]).join(','), it.note].join(' ').toLowerCase();
    return hay.includes(q);
  });
  listEl.innerHTML = items.map((it,i)=>cardTemplate(it,i)).join('') || '<div class="muted">Пока пусто. Нажмите «+ Добавить ткань».</div>';
  calc();
}

function openDialog(mode, idx=null){
  document.getElementById('fabricForm').classList.remove('readonly');
  saveBtn.style.display='';
  delBtn.style.display = (mode==='edit');
  if(mode==='view'){ delBtn.style.display='none'; saveBtn.style.display='none'; document.getElementById('fabricForm').classList.add('readonly'); }
  state.editId = idx;
  const it = idx!=null ? state.items[idx] : {name:'',type:'Хлопок',qty:'',tags:[],note:'',photo:''};
  dlgTitle.textContent = mode==='edit' ? 'Изменить ткань' : (mode==='view'?'Карточка ткани':'Добавить ткань');
  fName.value=it.name||''; fType.value=it.type||'Хлопок'; fQty.value=it.qty||''; fTags.value=(it.tags||[]).join(', '); fNote.value=it.note||''; fPrev.src=it.photo||'';
  fPhoto.value='';
  dlg.showModal();
}

function closeDialog(){ dlg.close(); }

// Events
$("#addFabric").addEventListener('click',()=>openDialog('add'));
$("#cancelBtn").addEventListener('click',closeDialog);
delBtn.addEventListener('click',()=>{
  if(state.editId==null) return;
  if(confirm('Удалить эту ткань?')){
    state.items.splice(state.editId,1);
    persist(); closeDialog(); render();
  }
});
saveBtn.addEventListener('click', async ()=>{
  const photoData = (fPhoto.files && fPhoto.files[0]) ? await resizeImage(fPhoto.files[0]) : fPrev.src || null;
  const item = {
    name:fName.value.trim(),
    type:fType.value,
    qty:Number(fQty.value||0),
    tags:(fTags.value||'').split(',').map(s=>s.trim()).filter(Boolean),
    note:fNote.value,
    photo: photoData
  };
  if(state.editId!=null){ state.items[state.editId]=item } else { state.items.unshift(item) }
  persist(); closeDialog(); render();
});

listEl.addEventListener('click', (e)=>{
  const card = e.target.closest('.card'); if(!card) return;
  const idx = Number(card.dataset.idx);
  const act = e.target.dataset.action;
  if(act==='edit'){ openDialog('edit', idx) }
  if(act==='view'){ openDialog('view', idx) }
});

$("#search").addEventListener('input', render);

// JSON
$("#exportJson").addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state.items,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ollys_dream_backup.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
});
$("#importJson").addEventListener('click', ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=()=>{
    const f=inp.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ try{ state.items=JSON.parse(r.result)||[]; persist(); render(); }catch{ alert('Неверный JSON') } };
    r.readAsText(f);
  };
  inp.click();
});

render();
</script>
</body>
</html>
