<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Olly's Dream</title>
<style>
  :root{
    --bg:#fde7ee;
    --card:#fff;
    --ink:#2b1e25;
    --ink-dim:#6b5a61;
    --accent:#ff6ea2;
    --accent-2:#ff9bc0;
    --pill:#ffd6e6;
    --ok:#2fb37c;
    --warn:#e86e3a;
    --shadow:0 8px 20px rgba(0,0,0,.08);
    --radius:18px;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:var(--ink);
  }
  .wrap{max-width:980px;margin:0 auto;padding:28px 16px 120px}
  h1{font-size:40px;margin:8px 0 12px}
  .sub{color:var(--ink-dim);opacity:.9;margin-bottom:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{
    background:#fff;border:0;padding:12px 16px;border-radius:999px;
    box-shadow:var(--shadow);cursor:pointer;font-weight:700
  }
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:var(--pill)}
  .tabs{display:flex;gap:16px;margin:18px 0 10px}
  .tab{padding:14px 22px;background:#fff;border-radius:999px;cursor:pointer;font-weight:800;box-shadow:var(--shadow);}
  .tab.active{background:var(--accent);color:#fff}
  .search{width:100%;padding:14px 18px;border-radius:14px;border:0;box-shadow:var(--shadow);}
  .stats{display:flex;gap:16px;margin:14px 0 8px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:#fff;padding:10px 14px;border-radius:999px;box-shadow:var(--shadow);font-weight:700}
  .list{display:grid;grid-template-columns:1fr;gap:14px;margin-top:8px}
  @media(min-width:720px){.list{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;display:flex;gap:14px;align-items:stretch}
  .thumb{width:110px;height:110px;border-radius:14px;overflow:hidden;background:#f3f0f2;flex:0 0 auto;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .thumb img{max-width:100%;max-height:100%;object-fit:cover;display:block}
  .grow{flex:1 1 auto}
  .name{font-size:22px;font-weight:900;margin:2px 0 6px;cursor:pointer;text-decoration:underline;text-decoration-color:rgba(0,0,0,.15)}
  .muted{color:var(--ink-dim)}
  .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .tag{background:var(--pill);padding:8px 12px;border-radius:999px;font-weight:700}
  .links{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .link-chip{background:#eef4ff;color:#243ea1;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
  .row-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
  .a{color:#274EA0;cursor:pointer;font-weight:700}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:20}
  .modal{background:#fff;max-width:760px;width:min(760px,100%);border-radius:20px;box-shadow:var(--shadow);padding:16px}
  .modal .title{font-size:22px;font-weight:900;margin:4px 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--ink-dim);font-weight:800}
  input,select,textarea{width:100%;padding:12px 12px;border:1px solid #e8e0e4;border-radius:12px;background:#fff}
  textarea{min-height:96px;resize:vertical}
  .modal .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
  /* lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:30}
  .lightbox img{max-width:92vw;max-height:92vh;border-radius:16px}
  /* pills on counters */
  .pill{background:#fff;border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);font-weight:800}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Olly's Dream</h1>
    <div class="sub">Ткани • Выкройки • Готовые изделия — офлайн, с сохранением</div>
    <div class="row">
      <button class="btn" id="btnExport">Экспорт JSON</button>
      <input type="file" id="importInput" accept="application/json" hidden>
      <button class="btn" id="btnImport">Импорт JSON</button>
      <span style="flex:1 1 auto"></span>
      <button class="btn primary" id="btnAdd">+ Добавить <span class="tabName">ткань</span></button>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="fabrics">Ткани</div>
      <div class="tab" data-tab="patterns">Выкройки</div>
      <div class="tab" data-tab="items">Готовые изделия</div>
    </div>

    <input class="search" id="search" placeholder="Поиск по названию, тегам, заметке…" />

    <div class="stats">
      <div class="pill">Всего: <b id="statTotal">0 м</b></div>
      <div class="pill">Списано: <b id="statSpent">0 м</b></div>
    </div>

    <div class="list" id="list"></div>
  </div>

  <!-- modal -->
  <div class="modal-back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title" id="modalTitle"></div>
      <form id="form">
        <div class="grid" id="formGrid"></div>
        <div class="actions">
          <button type="button" class="btn ghost" id="btnDelete">Удалить</button>
          <button type="button" class="btn" id="btnCancel">Отмена</button>
          <button type="submit" class="btn primary" id="btnSave">Сохранить</button>
        </div>
      </form>
    </div>
  </div>

  <!-- lightbox -->
  <div class="lightbox" id="lightbox"><img id="lightboxImg" alt=""></div>

<script>
/** -------- store & helpers -------- */
const LS_KEY = 'ollys-dream-v3';
function uid(){ return Math.random().toString(36).slice(2,9); }
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return { fabrics:[], patterns:[], items:[] };
    const data = JSON.parse(raw);
    ['fabrics','patterns','items'].forEach(k=> data[k] ||= []);
    return data;
  }catch(e){ return { fabrics:[], patterns:[], items:[] }; }
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }
function dataURLFromFile(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
let db = load();
let currentTab = 'fabrics';
let editing = null; // {type, id}

/** -------- UI binding -------- */
const listEl = document.getElementById('list');
const searchEl = document.getElementById('search');
const statTotal = document.getElementById('statTotal');
const statSpent = document.getElementById('statSpent');
const btnAdd = document.getElementById('btnAdd');
const tabNameSpan = document.querySelector('.tabName');

document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(tt=>tt.classList.remove('active'));
    t.classList.add('active');
    currentTab = t.dataset.tab;
    tabNameSpan.textContent = currentTab==='fabrics'?'ткань':currentTab==='patterns'?'выкройку':'изделие';
    render();
  });
});
btnAdd.addEventListener('click',()=> openForm(currentTab, null));
searchEl.addEventListener('input', render);

/** -------- Import / Export -------- */
document.getElementById('btnExport').addEventListener('click',()=>{
  const blob = new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ollys_dream_backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
});
document.getElementById('btnImport').addEventListener('click',()=>{
  document.getElementById('importInput').click();
});
document.getElementById('importInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    if(!obj || typeof obj!=='object') throw 0;
    db = { fabrics: obj.fabrics||[], patterns: obj.patterns||[], items: obj.items||[] };
    save(); render();
    alert('Импорт выполнен.');
  }catch(err){ alert('Не удалось импортировать файл.'); }
  e.target.value='';
});

/** -------- Render -------- */
function render(){
  const q = searchEl.value.trim().toLowerCase();
  listEl.innerHTML = '';
  const coll = db[currentTab];
  const filtered = coll.filter(it=>{
    const hay = (it.name+' '+(it.tags||[]).join(' ')+' '+(it.note||it.desc||'')).toLowerCase();
    return hay.includes(q);
  });
  // stats (только для тканей)
  if(currentTab==='fabrics'){
    const total = db.fabrics.reduce((s,f)=>s+(Number(f.qty)||0),0);
    const spent = db.fabrics.reduce((s,f)=>s+(Number(f.spent)||0),0);
    statTotal.textContent = total+' м';
    statSpent.textContent = spent+' м';
  }else{
    statTotal.textContent = '—';
    statSpent.textContent = '—';
  }
  filtered.forEach(it=> listEl.appendChild(card(it, currentTab)));
}
function makeLinkChip(type,id,label){
  const el = document.createElement('span');
  el.className='link-chip js-link';
  el.dataset.type=type; el.dataset.id=id;
  el.textContent=label;
  return el;
}
function card(it, type){
  const root = document.createElement('div');
  root.className = 'card';
  // thumb
  const th = document.createElement('div');
  th.className='thumb'; th.title='Открыть фото';
  if(it.photo){
    const img = document.createElement('img'); img.src = it.photo; th.appendChild(img);
  }else{ th.textContent='Фото'; }
  th.addEventListener('click',()=> openLightbox(it.photo));
  root.appendChild(th);
  const mid = document.createElement('div'); mid.className='grow';
  const name = document.createElement('div'); name.className='name a'; name.textContent=it.name||'(без названия)';
  name.addEventListener('click',()=> openView(type, it.id));
  mid.appendChild(name);
  if(type==='fabrics'){
    const line = document.createElement('div'); line.className='muted'; line.textContent = (it.note||'').trim() || '—'; mid.appendChild(line);
    const qty = document.createElement('div'); qty.className='muted'; qty.style.marginTop='4px'; qty.innerHTML = 'Кол-во: <b>'+ (Number(it.qty)||0) +' м</b>'; mid.appendChild(qty);
  }else if(type==='patterns'){
    const line = document.createElement('div'); line.className='muted'; line.textContent = (it.desc||'Выкройка'); mid.appendChild(line);
  }else{
    const line = document.createElement('div'); line.className='muted'; line.textContent = (it.desc||'Изделие'); mid.appendChild(line);
  }
  const tg = document.createElement('div'); tg.className='tags';
  (it.tags||[]).forEach(t=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=t; tg.appendChild(span); });
  mid.appendChild(tg);
  const links = document.createElement('div'); links.className='links';
  if(type!=='fabrics' && (it.fabricIds||[]).length){
    (it.fabricIds||[]).forEach(fid=>{ const f = db.fabrics.find(x=>x.id===fid); if(f) links.appendChild(makeLinkChip('fabrics', fid, 'Ткань: '+f.name)); });
  }
  if(type!=='patterns' && (it.patternIds||[]).length){
    (it.patternIds||[]).forEach(pid=>{ const p = db.patterns.find(x=>x.id===pid); if(p) links.appendChild(makeLinkChip('patterns', pid, 'Выкр.: '+p.name)); });
  }
  if(links.children.length) mid.appendChild(links);
  root.appendChild(mid);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='8px';
  const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='Изменить'; btnEdit.addEventListener('click',()=> openForm(type, it.id)); actions.appendChild(btnEdit);
  if(type==='fabrics'){ const btnWriteoff=document.createElement('button'); btnWriteoff.className='btn ghost'; btnWriteoff.textContent='Списать'; btnWriteoff.addEventListener('click',()=> writeOff(it.id)); actions.appendChild(btnWriteoff); }
  root.appendChild(actions);
  root.addEventListener('click', (e)=>{ const el = e.target.closest('.js-link'); if(!el) return; e.stopPropagation(); openView(el.dataset.type, el.dataset.id); });
  return root;
}

/** -------- Lightbox -------- */
const lightbox = document.getElementById('lightbox');
const lightboxImg = document.getElementById('lightboxImg');
function openLightbox(src){ if(!src) return; lightboxImg.src = src; lightbox.style.display='flex'; }
lightbox.addEventListener('click',()=>{ lightbox.style.display='none'; lightboxImg.src=''; });

/** -------- Forms & view modals -------- */
const modalBack = document.getElementById('modalBack');
const modalTitle = document.getElementById('modalTitle');
const form = document.getElementById('form');
const formGrid = document.getElementById('formGrid');
const btnDelete = document.getElementById('btnDelete');
const btnCancel = document.getElementById('btnCancel');
const btnSave = document.getElementById('btnSave');
btnCancel.addEventListener('click', closeModal);

function closeModal(){ modalBack.style.display='none'; form.reset(); formGrid.innerHTML=''; editing=null; btnSave.style.display=''; btnDelete.style.display=''; btnCancel.textContent='Отмена'; }

function viewTitleFor(type){
  return type==='fabrics' ? 'Ткань' : type==='patterns' ? 'Выкройка' : 'Изделие';
}

function openView(type, id){
  const coll = db[type];
  const it = coll.find(x=>x.id===id);
  if(!it) return;
  // read-only details + кнопка "Редактировать"
  modalTitle.textContent = viewTitleFor(type) + ': ' + it.name;
  formGrid.innerHTML='';
  const left = document.createElement('div');
  left.innerHTML = `
    <label>${type==='fabrics'?'Заметка':'Описание'}</label>
    <div class="muted" style="padding:10px 0 16px">${(it.note||it.desc||'—').toString().replace(/</g,'&lt;')}</div>
    <label>Теги</label>
    <div class="muted" style="padding:10px 0 16px">${(it.tags||[]).join(', ')||'—'}</div>
    ${type==='fabrics' ? `<label>Кол-во (м)</label><div class="muted" style="padding:10px 0 16px"><b>${Number(it.qty)||0}</b> (списано: <b>${Number(it.spent)||0}</b>)</div>`:''}
  `;
  const right = document.createElement('div');
  right.innerHTML = `
    <label>Фото</label>
    <div class="thumb" id="viewPhoto">${it.photo?`<img src="${it.photo}" alt="">`:'—'}</div>
    <div style="margin-top:8px" class="links"></div>
  `;
  formGrid.appendChild(left); formGrid.appendChild(right);
  // render cross-links
  const links = right.querySelector('.links');
  (it.fabricIds||[]).forEach(fid=>{ const f = db.fabrics.find(x=>x.id===fid); if(f) links.appendChild(makeLinkChip('fabrics', fid, 'Ткань: '+f.name)); });
  (it.patternIds||[]).forEach(pid=>{ const p = db.patterns.find(x=>x.id===pid); if(p) links.appendChild(makeLinkChip('patterns', pid, 'Выкр.: '+p.name)); });
  const ph = right.querySelector('#viewPhoto'); ph?.addEventListener('click',()=> it.photo && openLightbox(it.photo));
  // настройки кнопок
  btnDelete.style.display='none';
  btnSave.style.display='none';
  btnCancel.textContent='Закрыть';
  // добавим "Редактировать"
  const editBtn = document.createElement('button');
  editBtn.type='button'; editBtn.className='btn'; editBtn.textContent='Редактировать';
  editBtn.style.marginLeft='auto';
  const actionsRow = document.createElement('div'); actionsRow.className='actions';
  actionsRow.appendChild(document.createElement('span'));
  actionsRow.appendChild(editBtn);
  form.appendChild(actionsRow);
  editBtn.addEventListener('click', ()=>{ // перейти в режим редактирования
    actionsRow.remove();
    openForm(type, id);
  });
  modalBack.style.display='flex';
}

function openForm(type, id){
  editing = {type,id};
  const coll = db[type];
  const it = id ? {...coll.find(x=>x.id===id)} : { id: uid(), name:'', tags:[], photo:'', note:'', qty:0, spent:0, patternIds:[], fabricIds:[] };
  modalTitle.textContent = (id?'Изменить ':'Добавить ') + (type==='fabrics'?'ткань':type==='patterns'?'выкройку':'изделие');
  formGrid.innerHTML = '';
  const htmlLeft = document.createElement('div');
  htmlLeft.innerHTML = `
    <label>Название</label>
    <input required id="f_name" value="${it.name||''}"/>
    ${type==='fabrics'?`
      <label>Количество (метры)</label>
      <input id="f_qty" type="number" min="0" step="0.01" value="${it.qty||0}"/>
    `:''}
    <label>Теги (через запятую)</label>
    <input id="f_tags" value="${(it.tags||[]).join(', ')}"/>
    <label>${type==='fabrics'?'Заметка':'Описание'}</label>
    <textarea id="f_note">${(it.note||it.desc||'')}</textarea>
  `;
  const htmlRight = document.createElement('div');
  htmlRight.innerHTML = `
    <label>Фото (необязательно)</label>
    <div class="thumb" id="thumbBox">${it.photo?`<img id="thumbPrev" src="${it.photo}"/>`:`<span id="thumbPrev">Нет фото</span>`}</div>
    <input id="f_photo" type="file" accept="image/*" style="margin-top:8px"/>
    <div class="row" style="gap:8px;margin-top:8px">
      <button type="button" class="btn ghost" id="btnDelPhoto">Удалить фото</button>
      <button type="button" class="btn" id="btnPreviewBig">Открыть большое</button>
    </div>
    <div style="height:8px"></div>
    <label>Ссылки</label>
    <div style="font-size:12px;color:var(--ink-dim);margin-bottom:6px">Выберите связанные элементы — по ним можно будет открыть карточку из списка.</div>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      ${ type!=='fabrics' ? `<select id="f_fabrics" multiple style="min-width:240px;max-width:100%;height:92px"></select>`:''}
      ${ type!=='patterns' ? `<select id="f_patterns" multiple style="min-width:240px;max-width:100%;height:92px"></select>`:''}
    </div>
  `;
  formGrid.appendChild(htmlLeft);
  formGrid.appendChild(htmlRight);
  // populate selects
  if(type!=='fabrics'){
    const sel = document.getElementById('f_fabrics');
    db.fabrics.forEach(f=>{
      const o = document.createElement('option'); o.value=f.id; o.textContent='Ткань: '+f.name;
      if((it.fabricIds||[]).includes(f.id)) o.selected=true;
      sel.appendChild(o);
    });
  }
  if(type!=='patterns'){
    const sel = document.getElementById('f_patterns');
    db.patterns.forEach(p=>{
      const o = document.createElement('option'); o.value=p.id; o.textContent='Выкр.: '+p.name;
      if((it.patternIds||[]).includes(p.id)) o.selected=true;
      sel.appendChild(o);
    });
  }
  // handlers: photo preview + lightbox
  const thumbBox = document.getElementById('thumbBox');
  const thumbPrev = document.getElementById('thumbPrev');
  document.getElementById('f_photo').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const dataUrl = await dataURLFromFile(file);
    it.photo = dataUrl;
    thumbBox.innerHTML = `<img id="thumbPrev" src="${dataUrl}">`;
  });
  document.getElementById('btnDelPhoto').addEventListener('click',()=>{
    it.photo=''; thumbBox.innerHTML = '<span id="thumbPrev">Нет фото</span>';
  });
  document.getElementById('btnPreviewBig').addEventListener('click',()=>{
    if(it.photo) openLightbox(it.photo);
  });
  // а также клик по самой миниатюре
  thumbBox.addEventListener('click',()=>{ const img = thumbBox.querySelector('img'); if(img) openLightbox(img.src); });

  // buttons
  btnDelete.style.display = id ? '' : 'none';
  btnSave.style.display = '';
  btnCancel.textContent='Отмена';
  modalBack.style.display='flex';

  btnDelete.onclick = ()=>{
    if(confirm('Удалить запись?')){
      const idx = coll.findIndex(x=>x.id===it.id);
      if(idx>=0) coll.splice(idx,1);
      // чистим ссылки в других сущностях
      ['fabrics','patterns','items'].forEach(k=>{
        db[k].forEach(x=>{
          x.fabricIds = (x.fabricIds||[]).filter(v=>v!==it.id);
          x.patternIds = (x.patternIds||[]).filter(v=>v!==it.id);
        });
      });
      save(); closeModal(); render();
    }
  };
  form.onsubmit = (ev)=>{
    ev.preventDefault();
    it.name = document.getElementById('f_name').value.trim() || '(без названия)';
    const tags = document.getElementById('f_tags').value.trim();
    it.tags = tags? tags.split(',').map(s=>s.trim()).filter(Boolean):[];
    const note = document.getElementById('f_note').value;
    if(type==='fabrics'){ it.note = note; it.qty = Number(document.getElementById('f_qty').value||0); }
    if(type==='patterns'){ it.desc = note; }
    if(type==='items'){ it.desc = note; }
    if(type!=='fabrics'){ it.fabricIds = Array.from(document.getElementById('f_fabrics').selectedOptions||[]).map(o=>o.value); }
    if(type!=='patterns'){ it.patternIds = Array.from(document.getElementById('f_patterns').selectedOptions||[]).map(o=>o.value); }
    const idx = coll.findIndex(x=>x.id===it.id);
    if(idx>=0) coll[idx] = it; else coll.push(it);
    save(); closeModal(); render();
  };
}

function writeOff(fabricId){
  const f = db.fabrics.find(x=>x.id===fabricId);
  if(!f) return;
  const amount = prompt('Списать сколько метров?', '0');
  const n = Number(amount||0);
  if(!(n>0)) return;
  f.spent = Number(f.spent||0) + n;
  f.qty = Math.max(0, Number(f.qty||0) - n);
  save(); render();
}

/** init */
render();
</script>
</body>
</html>
