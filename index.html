<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Olly‚Äôs Dream ‚Ä¢ –¢–∫–∞–Ω–∏ ‚Ä¢ –í—ã–∫—Ä–æ–π–∫–∏ ‚Ä¢ –ì–æ—Ç–æ–≤—ã–µ –∏–∑–¥–µ–ª–∏—è</title>
<style>
  :root{
    --bg:#fff5f8;
    --card:#ffffff;
    --ink:#2b2431;
    --muted:#6e6273;
    --rose:#ff6aa2;
    --rose-2:#ffd6e6;
    --rose-3:#ffeaf3;
    --danger:#e74c3c;
    --br:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Inter,system-ui,Arial;}
  body{background:var(--bg);color:var(--ink);}
  .wrap{max-width:940px;margin:0 auto;padding:20px 16px 120px;}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap; margin-bottom:12px;}
  .brand{font-size:34px;font-weight:800;letter-spacing:.3px}
  .pill{display:inline-flex;align-items:center;gap:10px;background:var(--card);border:1px solid #eee;border-radius:999px;padding:10px 14px;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--card);border:1px solid #e9e1e5;border-radius:999px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--rose);border-color:var(--rose);color:white}
  .btn.danger{border-color:var(--danger);color:var(--danger);background:#fff}
  .tabs{display:flex;gap:10px;margin:8px 0 12px;flex-wrap:wrap}
  .tabbtn{background:var(--rose-3);border:1px solid var(--rose-2);border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
  .tabbtn.active{background:var(--rose);border-color:var(--rose);color:white}
  .search{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #eadfe5;background:white}
  .stats{display:flex;gap:10px;margin:10px 0 16px;flex-wrap:wrap}
  .chip{background:white;border:1px solid #eadfe5;border-radius:999px;padding:8px 12px;color:#433b46}
  .right{margin-left:auto}
  .hint{color:var(--muted);font-size:14px}
  .card{background:var(--card);border:1px solid #eee;border-radius:var(--br);padding:12px}
  .list{display:grid;gap:10px}
  .fab-item{display:grid;grid-template-columns:auto 1fr auto;gap:12px;padding:12px;border-radius:12px;border:1px solid #eee;background:white;align-items:center}
  .fab-item small{color:var(--muted)}
  .thumb{width:72px;height:72px;border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff;display:grid;place-items:center;color:#bbb}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .badge{display:inline-block;background:white;border:1px solid #eadfe5;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:12px;color:#433b46}
  /* Modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;}
  .modal{background:white;border-radius:16px 16px 0 0;padding:16px 16px 20px;width:100%;max-width:940px;margin:0 auto;}
  .modal h3{margin:0 0 12px}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  label{font-size:13px;color:#584f5c}
  input,select,textarea{width:100%;padding:12px;border:1px solid #e6dbe2;border-radius:12px}
  .modal-actions{display:flex;gap:8px;justify-content:space-between;margin-top:10px;align-items:center}
  .hide{display:none!important}
  .preview{display:flex;gap:10px;align-items:center}
  .preview .thumb{width:86px;height:86px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Olly‚Äôs Dream</div>
      <div class="pill hint">–¢–∫–∞–Ω–∏ ‚Ä¢ –í—ã–∫—Ä–æ–π–∫–∏ ‚Ä¢ –ì–æ—Ç–æ–≤—ã–µ –∏–∑–¥–µ–ª–∏—è ‚Äî –æ—Ñ–ª–∞–π–Ω, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º</div>
      <div class="right row">
        <button id="exportBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <label class="btn" for="importInput" style="cursor:pointer">–ò–º–ø–æ—Ä—Ç JSON</label>
        <input id="importInput" type="file" accept="application/json" class="hide">
      </div>
    </header>

    <div class="tabs">
      <button class="tabbtn active" data-tab="fabrics">–¢–∫–∞–Ω–∏</button>
      <button class="tabbtn" data-tab="patterns">–í—ã–∫—Ä–æ–π–∫–∏</button>
      <button class="tabbtn" data-tab="products">–ì–æ—Ç–æ–≤—ã–µ –∏–∑–¥–µ–ª–∏—è</button>
    </div>

    <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, —Ç–∏–ø—É, —Ç–µ–≥–∞–º‚Ä¶" />

    <div class="stats">
      <div class="chip">–í—Å–µ–≥–æ: <span id="totalMeters">0</span> –º</div>
      <div class="chip">–°–ø–∏—Å–∞–Ω–æ: <span id="writtenOff">0</span> –º</div>
      <div class="right">
        <button id="addFabricBtn" class="btn primary">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∫–∞–Ω—å</button>
      </div>
    </div>

    <div id="content" class="list"></div>

    <p class="hint">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –î–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–≠–∫—Å–ø–æ—Ä—Ç JSON¬ª.</p>
  </div>

  <!-- Modal Add/Edit Fabric -->
  <div class="modal-back" id="modalBack">
    <div class="modal">
      <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–∫–∞–Ω—å</h3>
      <div class="grid grid-2">
        <div>
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="fName" placeholder="–ù–∞–ø—Ä.: –°–∞—Ç–∏–Ω —Ä–æ–∑–æ–≤—ã–π" />
        </div>
        <div>
          <label>–¢–∏–ø</label>
          <select id="fType">
            <option value="—Ö–±">–•–ª–æ–ø–æ–∫</option>
            <option value="—Å–∞—Ç–∏–Ω">–°–∞—Ç–∏–Ω</option>
            <option value="–ª–µ–Ω">–õ—ë–Ω</option>
            <option value="—à–µ–ª–∫">–®—ë–ª–∫</option>
            <option value="—Ñ–ª–∏—Å">–§–ª–∏—Å</option>
            <option value="–ø—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
          </select>
        </div>
        <div>
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º–µ—Ç—Ä—ã)</label>
          <input id="fMeters" type="number" min="0" step="0.1" placeholder="–ù–∞–ø—Ä.: 1.8" />
        </div>
        <div>
          <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input id="fTags" placeholder="—Ä–æ–∑–æ–≤—ã–π, –¥–µ—Ç—Å–∫–æ–µ, 150—Å–º" />
        </div>
        <div class="grid" style="grid-column:1 / -1">
          <label>–ó–∞–º–µ—Ç–∫–∞</label>
          <textarea id="fNote" rows="2" placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –≥–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∏ —Ç. –ø."></textarea>
        </div>
        <div class="grid" style="grid-column:1 / -1">
          <label>–§–æ—Ç–æ —Ç–∫–∞–Ω–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <div class="preview">
            <div class="thumb" id="photoPreview">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
            <input id="fPhoto" type="file" accept="image/*" />
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="deleteFabric" class="btn danger hide">–£–¥–∞–ª–∏—Ç—å —Ç–∫–∞–Ω—å</button>
        <div class="row" style="gap:8px;margin-left:auto">
          <button id="cancelModal" class="btn">–û—Ç–º–µ–Ω–∞</button>
          <button id="saveFabric" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const LS_KEY = 'od_fabrics_v2';

  /** @type {Array<{id:string,name:string,type:string,meters:number,tags:string[],note:string,photo?:string,writtenOff:number,created:number}>} */
  let fabrics = [];

  // --- Storage helpers
  const load = () => {
    try{
      const raw = localStorage.getItem(LS_KEY);
      fabrics = raw ? JSON.parse(raw) : [];
    }catch(e){ fabrics = []; }
  };
  const save = () => localStorage.setItem(LS_KEY, JSON.stringify(fabrics));

  // --- UI elements
  const content = document.getElementById('content');
  const totalMetersEl = document.getElementById('totalMeters');
  const writtenOffEl = document.getElementById('writtenOff');
  const search = document.getElementById('search');
  const modalBack = document.getElementById('modalBack');
  const addBtn = document.getElementById('addFabricBtn');
  const modalTitle = document.getElementById('modalTitle');
  const deleteBtn = document.getElementById('deleteFabric');

  // Form fields
  const fName = document.getElementById('fName');
  const fType = document.getElementById('fType');
  const fMeters = document.getElementById('fMeters');
  const fTags = document.getElementById('fTags');
  const fNote = document.getElementById('fNote');
  const fPhotoInp = document.getElementById('fPhoto');
  const photoPreview = document.getElementById('photoPreview');

  let editingId = null; // null => add, string => edit

  // Modal controls
  const openModal = (mode, item) => {
    editingId = mode === 'edit' ? item.id : null;
    modalTitle.textContent = mode === 'edit' ? '–ò–∑–º–µ–Ω–∏—Ç—å —Ç–∫–∞–Ω—å' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–∫–∞–Ω—å';
    deleteBtn.classList.toggle('hide', mode !== 'edit');

    if(mode === 'edit'){
      fName.value = item.name || '';
      fType.value = item.type || '—Ö–±';
      fMeters.value = (item.meters ?? '').toString();
      fTags.value = (item.tags || []).join(', ');
      fNote.value = item.note || '';
      if(item.photo){
        const img = document.createElement('img');
        img.src = item.photo;
        photoPreview.innerHTML = '';
        photoPreview.appendChild(img);
      } else {
        photoPreview.textContent = '–ù–µ—Ç —Ñ–æ—Ç–æ';
      }
    } else {
      clearModal();
    }

    modalBack.style.display = 'flex';
  };
  const closeModal = () => { modalBack.style.display = 'none'; clearModal(); };

  document.getElementById('cancelModal').onclick = closeModal;
  addBtn.onclick = () => openModal('add');

  function clearModal(){
    fName.value = '';
    fType.value = '—Ö–±';
    fMeters.value = '';
    fTags.value = '';
    fNote.value = '';
    fPhotoInp.value = '';
    photoPreview.textContent = '–ù–µ—Ç —Ñ–æ—Ç–æ';
  }

  // File to DataURL
  function fileToDataURL(file){
    return new Promise((res, rej)=>{
      const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
    });
  }
  let tempPhotoData = null;
  fPhotoInp.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file){ tempPhotoData = null; photoPreview.textContent='–ù–µ—Ç —Ñ–æ—Ç–æ'; return; }
    const data = await fileToDataURL(file);
    tempPhotoData = data;
    const img = document.createElement('img');
    img.src = data;
    photoPreview.innerHTML = '';
    photoPreview.appendChild(img);
  });

  // Save (add or edit)
  document.getElementById('saveFabric').onclick = () => {
    const name = fName.value.trim();
    const type = fType.value;
    const meters = parseFloat(String(fMeters.value).replace(',', '.'));
    const tags = fTags.value.split(',').map(s=>s.trim()).filter(Boolean);
    const note = fNote.value.trim();
    if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∫–∞–Ω–∏.'); return; }
    if(!meters || meters <= 0){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Ç—Ä–æ–≤ (> 0).'); return; }

    if(editingId){
      const item = fabrics.find(x => x.id === editingId);
      if(!item) return;
      item.name = name;
      item.type = type;
      item.meters = meters;
      item.tags = tags;
      item.note = note;
      if(tempPhotoData){ item.photo = tempPhotoData; }
    } else {
      const item = {
        id: 'fab_' + Date.now(),
        name, type, meters, tags, note,
        photo: tempPhotoData || null,
        writtenOff: 0,
        created: Date.now()
      };
      fabrics.unshift(item);
    }

    tempPhotoData = null;
    save();
    closeModal();
    render();
  };

  // Delete in modal (only in edit mode)
  deleteBtn.onclick = () => {
    if(!editingId) return;
    if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–∫–∞–Ω—å?')){
      fabrics = fabrics.filter(x => x.id !== editingId);
      save();
      closeModal();
      render();
    }
  };

  // Render list + totals
  function render(){
    const q = (search.value||'').toLowerCase();
    let items = fabrics;
    if(q){
      items = items.filter(it => (
        it.name.toLowerCase().includes(q) ||
        it.type.toLowerCase().includes(q) ||
        it.tags.join(' ').toLowerCase().includes(q) ||
        (it.note||'').toLowerCase().includes(q)
      ));
    }

    const total = fabrics.reduce((s, it)=> s + (it.meters||0), 0);
    const written = fabrics.reduce((s, it)=> s + (it.writtenOff||0), 0);
    totalMetersEl.textContent = total.toFixed(2).replace(/\.00$/, '');
    writtenOffEl.textContent = written.toFixed(2).replace(/\.00$/, '');

    if(items.length === 0){
      content.innerHTML = '<div class="card hint">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –ù–∞–∂–º–∏ ¬´+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∫–∞–Ω—å¬ª, —á—Ç–æ–±—ã –≤–Ω–µ—Å—Ç–∏ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å.</div>';
      return;
    }

    content.innerHTML = items.map(it => `
      <div class="fab-item" data-id="${it.id}">
        <div class="thumb">${it.photo ? `<img src="${it.photo}" alt="–§–æ—Ç–æ —Ç–∫–∞–Ω–∏">` : '–§–æ—Ç–æ'}</div>
        <div>
          <strong>${escapeHtml(it.name)}</strong>
          <div class="hint">${escapeHtml(it.type)} ‚Ä¢ ${fmtMeters(it.meters)} –º ${it.tags?.length? it.tags.map(escapeHtml).map(t=>`<span class="badge">${t}</span>`).join(' '):''}</div>
          ${it.note ? `<small>${escapeHtml(it.note)}</small>`:''}
        </div>
        <div class="row" style="gap:6px; align-self:center">
          <button class="btn" data-action="writeoff" title="–°–ø–∏—Å–∞—Ç—å 0.1 –º">-0.1</button>
          <button class="btn" data-action="plus" title="–î–æ–±–∞–≤–∏—Ç—å 0.1 –º">+0.1</button>
          <button class="btn" data-action="edit" title="–ò–∑–º–µ–Ω–∏—Ç—å">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    `).join('');

    // attach actions
    content.querySelectorAll('.fab-item .btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const action = e.currentTarget.getAttribute('data-action');
        const id = e.currentTarget.closest('.fab-item').getAttribute('data-id');
        const item = fabrics.find(f => f.id === id);
        if(!item) return;
        if(action === 'edit'){
          tempPhotoData = null; // reset temp
          openModal('edit', item);
        }else if(action === 'writeoff'){
          item.meters = Math.max(0, +(item.meters - 0.1).toFixed(2));
          item.writtenOff = +(item.writtenOff + 0.1).toFixed(2);
          save(); render();
        }else if(action === 'plus'){
          item.meters = +(item.meters + 0.1).toFixed(2);
          save(); render();
        }
      });
    });
  }

  function fmtMeters(n){ return (n||0).toFixed(2).replace(/\.00$/,''); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // Search
  search.addEventListener('input', render);

  // Tabs (other tabs as stubs)
  document.querySelectorAll('.tabbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const tab = b.dataset.tab;
      if(tab === 'fabrics'){
        document.getElementById('addFabricBtn').classList.remove('hide');
        render();
      }else{
        document.getElementById('addFabricBtn').classList.add('hide');
        content.innerHTML = '<div class="card hint">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üíï</div>';
      }
    });
  });

  // Export / Import
  document.getElementById('exportBtn').onclick = () => {
    const data = { fabrics };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ollys_dream_backup.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
  };

  document.getElementById('importInput').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(Array.isArray(data)) fabrics = data;
      else if(data && Array.isArray(data.fabrics)) fabrics = data.fabrics;
      else throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
      save(); render();
      alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ');
    }catch(err){
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: ' + err.message);
    }finally{
      e.target.value = '';
    }
  });

  // Init
  load();
  render();

  // Close modal on backdrop click
  modalBack.addEventListener('click', (e)=>{
    if(e.target === modalBack) closeModal();
  });
})();
</script>
</body>
</html>
