<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Olly’s Dream</title>
<style>
  :root{
    --bg:#f8e6ee;
    --panel:#ffffff;
    --text:#2b2b2b;
    --muted:#666;
    --accent:#ff7aa2;
    --accent-2:#f0aec4;
    --chip:#ffe1eb;
    --ok:#35a854;
    --danger:#dd3b3b;
    --shadow:0 6px 24px rgba(0,0,0,.08);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  header h1{margin:.2rem 0 0 0;font-size:34px;letter-spacing:.3px}
  header .sub{color:var(--muted);margin-top:6px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0}
  .btn{appearance:none;border:0;outline:0;padding:11px 16px;border-radius:999px;background:#fff;box-shadow:var(--shadow);color:#222;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:#fff}
  .btn.small{padding:8px 12px;font-weight:600}
  .tabs{display:flex;gap:12px;margin:8px 0 14px 0}
  .tab{padding:12px 18px;border-radius:999px;background:#fff;box-shadow:var(--shadow);cursor:pointer;font-weight:700}
  .tab.active{background:var(--accent);color:#fff}
  .search{display:flex;gap:10px;margin:8px 0 18px 0}
  .search input{flex:1;border:0;padding:14px 16px;border-radius:12px;background:#fff;box-shadow:var(--shadow);font-size:16px}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .chip{background:var(--chip);padding:6px 10px;border-radius:999px;color:#333;font-weight:600}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
  .card{background:var(--panel);border-radius:16px;box-shadow:var(--shadow);padding:12px;display:flex;gap:12px;align-items:flex-start}
  .thumb{width:72px;height:72px;border-radius:10px;background:#f3f3f3;flex:0 0 auto;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;display:block}
  .card h3{margin:0 0 4px 0;font-size:18px}
  .meta{color:var(--muted);font-size:14px;margin-bottom:8px}
  .badge{display:inline-block;padding:3px 8px;background:#f4f4f4;border-radius:999px;margin-right:6px;font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row .btn{flex:1}
  footer{color:#7b7b7b;margin:24px 4px}
  /* Modal */
  dialog{border:0;border-radius:18px;width:min(720px,92vw);padding:0;box-shadow:var(--shadow)}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .modal-head{padding:16px 18px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
  .modal-body{padding:16px 18px}
  .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .modal-grid .full{grid-column:1/-1}
  label{font-size:13px;color:#666;margin-bottom:6px;display:block}
  input[type="text"], input[type="number"], textarea, select {width:100%;padding:12px 12px;border:1px solid #e9e9e9;border-radius:12px;background:#fff;outline:none;font-size:16px}
  textarea{min-height:90px;resize:vertical}
  .fileRow{display:flex;align-items:center;gap:12px}
  .fileRow .thumb{width:84px;height:84px}
  .danger{background:var(--danger);color:#fff}
  .ok{background:var(--ok);color:#fff}
  .muted{background:#ececec}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}
  .hidden{display:none !important}
  .pill{padding:6px 10px;border-radius:999px;background:#fff;box-shadow:var(--shadow);font-weight:700}
  .counter{display:flex;gap:10px;margin:10px 0}
  .counter .pill{background:#fff}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Olly’s Dream</h1>
      <div class="sub">Ткани • Выкройки • Готовые изделия — офлайн, с сохранением</div>
    </header>

    <div class="toolbar">
      <button class="btn ghost" id="exportBtn">Экспорт JSON</button>
      <input id="importFile" class="hidden" type="file" accept="application/json"/>
      <button class="btn ghost" id="importBtn">Импорт JSON</button>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="fabrics">Ткани</div>
      <div class="tab" data-tab="patterns">Выкройки</div>
      <div class="tab" data-tab="products">Готовые изделия</div>
    </div>

    <div class="search">
      <input id="searchInput" placeholder="Поиск по названию, типу, тегам…"/>
      <button id="addBtn" class="btn primary">+ Добавить ткань</button>
    </div>

    <div class="counter">
      <div class="pill">Всего: <b id="totalMeters">0 м</b></div>
      <div class="pill">Списано: <b id="spentMeters">0 м</b></div>
    </div>

    <div id="cards" class="grid"></div>

    <footer>Данные сохраняются локально в браузере (localStorage). Для резервной копии используйте «Экспорт JSON».</footer>
  </div>

  <dialog id="fabricModal">
    <form method="dialog">
      <div class="modal-head">
        <div style="font-weight:800">Добавить ткань</div>
        <button id="closeModal" class="btn muted" type="button">Закрыть</button>
      </div>
      <div class="modal-body">
        <div class="modal-grid">
          <div>
            <label for="fabricName">Название</label>
            <input id="fabricName" type="text" placeholder="Кулирка"/>
          </div>
          <div>
            <label for="fabricType">Тип</label>
            <select id="fabricType">
              <option value="">—</option>
              <option>Хлопок</option>
              <option>Лён</option>
              <option>Шерсть</option>
              <option>Трикотаж</option>
              <option>Джинса</option>
              <option>Синтетика</option>
            </select>
          </div>
          <div>
            <label for="fabricQty">Количество (метры)</label>
            <input id="fabricQty" inputmode="decimal" type="text" placeholder="например, 2,5"/>
          </div>
          <div>
            <label for="fabricTags">Теги (через запятую)</label>
            <input id="fabricTags" type="text" placeholder="розовый, детское, 150см"/>
          </div>
          <div class="full">
            <label for="fabricNote">Заметка</label>
            <textarea id="fabricNote" placeholder="Особенности, где хранится и т. п."></textarea>
          </div>
          <div class="full">
            <label>Фото ткани (необязательно)</label>
            <div class="fileRow">
              <div class="thumb" id="fabricPreview"><span style="font-size:12px;color:#aaa">нет фото</span></div>
              <input id="fabricPhoto" type="file" accept="image/*">
            </div>
          </div>
          <div class="full actions">
            <button id="deleteBtn" class="btn danger hidden" type="button">Удалить</button>
            <div style="flex:1"></div>
            <button id="cancelBtn" class="btn muted" type="button">Отмена</button>
            <button id="fabricSaveBtn" class="btn primary" type="button">Сохранить</button>
          </div>
        </div>
      </div>
    </form>
  </dialog>

<script>
(() => {
  const KEY = 'od_fabrics';

  const dom = {
    cards: document.getElementById('cards'),
    addBtn: document.getElementById('addBtn'),
    search: document.getElementById('searchInput'),
    totalMeters: document.getElementById('totalMeters'),
    spentMeters: document.getElementById('spentMeters'),
    exportBtn: document.getElementById('exportBtn'),
    importBtn: document.getElementById('importBtn'),
    importFile: document.getElementById('importFile'),
    // modal
    modal: document.getElementById('fabricModal'),
    closeModal: document.getElementById('closeModal'),
    cancelBtn: document.getElementById('cancelBtn'),
    saveBtn: document.getElementById('fabricSaveBtn'),
    delBtn: document.getElementById('deleteBtn'),
    name: document.getElementById('fabricName'),
    type: document.getElementById('fabricType'),
    qty: document.getElementById('fabricQty'),
    tags: document.getElementById('fabricTags'),
    note: document.getElementById('fabricNote'),
    file: document.getElementById('fabricPhoto'),
    preview: document.getElementById('fabricPreview'),
  };

  function uid() {
    return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));
  }

  function parseNum(v){
    if (!v) return 0;
    v = String(v).replace(',', '.').trim();
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : 0;
  }

  function read() {
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch { return []; }
  }
  function write(list) {
    localStorage.setItem(KEY, JSON.stringify(list));
  }

  function resizeImageToDataURL(file, maxSide = 1024, quality = 0.75){
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let {width, height} = img;
          if (width > height) {
            if (width > maxSide) { height = Math.round(height * (maxSide/width)); width = maxSide; }
          } else {
            if (height > maxSide) { width = Math.round(width * (maxSide/height)); height = maxSide; }
          }
          canvas.width = width; canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          try {
            const data = canvas.toDataURL('image/jpeg', quality);
            resolve(data);
          } catch(err){ reject(err); }
        };
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function imgTag(data){
    return data ? '<img alt="">' : '<span style="font-size:12px;color:#aaa">нет фото</span>';
  }

  function render(list = read(), q = dom.search.value.trim().toLowerCase()){
    const items = list.filter(x => {
      if (!q) return true;
      const hay = [x.name, x.type, (x.tags||[]).join(',')].join(' ').toLowerCase();
      return hay.includes(q);
    });
    dom.cards.innerHTML = items.map(x => `
      <div class="card">
        <div class="thumb">${imgTag(x.image)}</div>
        <div style="flex:1">
          <h3>${escapeHtml(x.name || '')}</h3>
          <div class="meta">${escapeHtml(x.type || '—')}</div>
          <div class="meta">Кол-во: <b>${(x.qty ?? 0)}</b> м</div>
          <div class="chips">${(x.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join('')}</div>
          <div class="row">
            <button class="btn small" data-edit="${x.id}">Изменить</button>
          </div>
        </div>
      </div>
    `).join('');

    // вставляем изображения
    Array.from(dom.cards.querySelectorAll('.card')).forEach((node, i) => {
      const item = items[i];
      const img = node.querySelector('img');
      if (img && item.image) img.src = item.image;
    });

    const total = list.reduce((s,x)=> s + (parseFloat(x.qty)||0), 0);
    dom.totalMeters.textContent = `${(+total.toFixed(2))} м`;
    dom.spentMeters.textContent = `0 м`; // если появится логика списаний — подставим
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function clearForm(){
    dom.name.value = '';
    dom.type.value = '';
    dom.qty.value = '';
    dom.tags.value = '';
    dom.note.value = '';
    dom.file.value = '';
    dom.preview.innerHTML = '<span style="font-size:12px;color:#aaa">нет фото</span>';
    window._editing = null;
    dom.delBtn.classList.add('hidden');
  }

  function openCreate(){
    clearForm();
    dom.modal.showModal();
  }
  function openEdit(item){
    clearForm();
    window._editing = item;
    dom.name.value = item.name || '';
    dom.type.value = item.type || '';
    dom.qty.value = (item.qty ?? '') + '';
    dom.tags.value = (item.tags||[]).join(', ');
    dom.note.value = item.note || '';
    if (item.image){
      dom.preview.innerHTML = '<img alt="" style="max-width:100%;max-height:100%"/>';
      const img = dom.preview.querySelector('img');
      img.src = item.image;
    }
    dom.delBtn.classList.remove('hidden');
    dom.modal.showModal();
  }

  async function saveFromForm(){
    let list = read();
    const isEdit = !!window._editing;
    const id = isEdit ? window._editing.id : uid();
    const imagePrev = isEdit ? window._editing.image : null;

    const name = dom.name.value.trim();
    if (!name){ alert('Введите название ткани'); return; }

    const payload = {
      id,
      name,
      type: dom.type.value,
      qty: parseNum(dom.qty.value),
      tags: (dom.tags.value||'').split(',').map(t=>t.trim()).filter(Boolean),
      note: dom.note.value.trim(),
      image: imagePrev,
      updatedAt: Date.now(),
      createdAt: isEdit ? (window._editing.createdAt || Date.now()) : Date.now()
    };

    const file = dom.file.files && dom.file.files[0];
    if (file){
      try {
        payload.image = await resizeImageToDataURL(file, 1024, .78);
      } catch (err) {
        console.warn('Image read failed', err);
        alert('Не удалось обработать фото. Сохраню без него.');
        payload.image = imagePrev || null;
      }
    }

    const ix = list.findIndex(x => x.id === id);
    if (ix >= 0) list[ix] = payload;
    else list.push(payload);
    write(list);
    dom.modal.close();
    render();
  }

  function removeCurrent(){
    if (!window._editing) return dom.modal.close();
    if (!confirm('Удалить эту ткань?')) return;
    let list = read().filter(x => x.id !== window._editing.id);
    write(list);
    dom.modal.close();
    render();
  }

  // EVENTS
  dom.addBtn.addEventListener('click', openCreate);
  dom.closeModal.addEventListener('click', () => dom.modal.close());
  dom.cancelBtn.addEventListener('click', () => dom.modal.close());
  dom.saveBtn.addEventListener('click', () => saveFromForm());
  dom.delBtn.addEventListener('click', removeCurrent);
  dom.search.addEventListener('input', ()=>render());

  dom.file.addEventListener('change', () => {
    const file = dom.file.files && dom.file.files[0];
    if (!file){ dom.preview.innerHTML = '<span style="font-size:12px;color:#aaa">нет фото</span>'; return; }
    const reader = new FileReader();
    reader.onload = () => {
      dom.preview.innerHTML = '<img alt="" style="max-width:100%;max-height:100%"/>';
      dom.preview.querySelector('img').src = reader.result;
    };
    reader.readAsDataURL(file);
  });

  dom.cards.addEventListener('click', (e)=>{
    const editId = e.target.closest('[data-edit]')?.getAttribute('data-edit');
    if (editId){
      const item = read().find(x => x.id === editId);
      if (item) openEdit(item);
    }
  });

  // Экспорт/импорт
  dom.exportBtn.addEventListener('click', () => {
    const data = JSON.stringify(read(), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ollys_dream_backup.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  dom.importBtn.addEventListener('click', ()=>dom.importFile.click());
  dom.importFile.addEventListener('change', () => {
    const file = dom.importFile.files && dom.importFile.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const arr = JSON.parse(reader.result);
        if (!Array.isArray(arr)) throw new Error('bad json');
        write(arr);
        alert('Импорт завершён');
        render();
      }catch(e){ alert('Не удалось импортировать JSON'); }
    };
    reader.readAsText(file, 'utf-8');
  });

  // init
  render();
})();
</script>
</body>
</html>
