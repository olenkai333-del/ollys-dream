<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Olly’s Dream</title>
<style>
  :root{
    --bg:#fde7ef;
    --card:#fff;
    --ink:#241b1e;
    --muted:#6d6166;
    --accent:#ff6fa3;
    --accent-2:#ffc4d9;
    --chip:#ffe7f0;
    --shadow: 0 10px 30px rgba(0,0,0,.08);
    --radius:18px;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
  .wrap{max-width:980px;margin:0 auto;padding:22px 16px 96px;}
  h1{font-size:40px;margin:8px 0 12px;font-weight:800;letter-spacing:.2px}
  .sub{opacity:.8;background:rgba(255,255,255,.6);padding:14px 18px;border-radius:14px;backdrop-filter:saturate(130%) blur(2px);}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:18px 0 10px}
  .btn{appearance:none;border:0;background:var(--card);padding:14px 18px;border-radius:999px;box-shadow:var(--shadow);font-weight:700}
  .btn:active{transform:translateY(1px)}
  .btn--ghost{background:var(--chip);}
  .btn--accent{background:var(--accent);color:#fff}
  .tabs{display:flex;gap:16px;margin:18px 0}
  .tab{padding:16px 26px;border-radius:999px;background:var(--card);box-shadow:var(--shadow);font-weight:800;opacity:.7}
  .tab.active{background:var(--accent-2);opacity:1}
  .search{width:100%;padding:16px 18px;border-radius:14px;border:0;background:var(--card);box-shadow:var(--shadow);}
  .stats{display:flex;gap:16px;margin:14px 0 6px}
  .pill{padding:10px 16px;border-radius:999px;background:var(--card);box-shadow:var(--shadow);font-weight:800}
  .grid{display:grid;gap:16px;margin-top:10px}
  @media(min-width:740px){ .grid{grid-template-columns:repeat(2,1fr);} }
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;position:relative}
  .card__body{padding:16px 16px 14px}
  .thumb{width:112px;height:112px;object-fit:cover;border-radius:12px;background:#f3f3f3;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}
  .row-split{display:grid;grid-template-columns:112px 1fr;gap:14px;align-items:center}
  .name{font-weight:900;font-size:22px;margin:0 0 8px;cursor:pointer;text-decoration:underline 2px rgba(0,0,0,.08)}
  .muted{color:var(--muted)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
  .chip{background:var(--chip);border-radius:999px;padding:6px 10px;font-weight:700}
  .row-actions{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:8px}
  .link{font-weight:800;color:#222;opacity:.7;text-decoration:underline;cursor:pointer}
  /* modal */
  dialog{border:0;border-radius:20px;box-shadow:var(--shadow);width:min(720px,92vw);}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .form{display:grid;gap:12px}
  .field{display:grid;gap:6px}
  label{font-weight:800}
  input[type="text"], input[type="number"], textarea, select{width:100%;padding:14px;border-radius:12px;border:0;background:#f9f9fb;box-shadow:inset 0 0 0 1px rgba(0,0,0,.07)}
  textarea{min-height:96px;resize:vertical}
  .filebox{display:flex;align-items:center;gap:12px}
  .preview{width:96px;height:96px;border-radius:12px;object-fit:cover;background:#f1f1f3;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}
  .bar{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .danger{background:#ffdde6;color:#8a123a}
  .tiny{font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Olly’s Dream</h1>
    <div class="sub">Ткани • Выкройки • Готовые изделия — офлайн, с сохранением</div>

    <div class="row">
      <button class="btn btn--ghost" id="btnExport">Экспорт JSON</button>
      <label class="btn btn--ghost" for="importFile">Импорт JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="fabrics">Ткани</div>
      <div class="tab" data-tab="patterns">Выкройки</div>
      <div class="tab" data-tab="products">Готовые изделия</div>
    </div>

    <input id="search" class="search" placeholder="Поиск по названию, тегам, заметке…"/>

    <div class="stats" id="stats">
      <div class="pill">Всего: <b id="statTotal">0 м</b></div>
      <div class="pill">Списано: <b id="statSpent">0 м</b></div>
    </div>

    <div class="row">
      <button class="btn btn--accent" id="btnAdd">+ Добавить ткань</button>
    </div>

    <div class="grid" id="list"></div>
  </div>

  <!-- Modals -->
  <dialog id="editDialog">
    <form method="dialog" class="form" id="editForm">
      <h3 id="dlgTitle" style="margin:0 0 6px;font-size:22px;font-weight:900">Добавить</h3>
      <div class="bar tiny muted"><span id="dlgHint">Заполните поля и нажмите «Сохранить»</span><span id="dlgId"></span></div>
      <div class="field"><label>Название</label><input required type="text" id="f_name"></div>
      <div class="field" data-for="type"><label>Тип</label>
        <select id="f_type">
          <option>Хлопок</option><option>Лён</option><option>Шерсть</option><option>Шёлк</option><option>Синтетика</option>
        </select>
      </div>
      <div class="field"><label>Количество (метры)</label><input required type="number" step="0.01" min="0" id="f_qty"></div>
      <div class="field"><label>Теги (через запятую)</label><input type="text" id="f_tags" placeholder="розовый, детское, 150см"></div>
      <div class="field"><label>Заметка</label><textarea id="f_note" placeholder="Особенности, где хранится и т. п."></textarea></div>
      <div class="field">
        <label>Фото (необязательно)</label>
        <div class="filebox">
          <img id="f_preview" class="preview" alt=""/>
          <input id="f_file" type="file" accept="image/*">
          <button type="button" class="btn tiny danger" id="btnClearPhoto">Удалить фото</button>
        </div>
      </div>
      <div class="bar">
        <div style="display:flex;gap:8px;align-items:center">
          <button type="button" class="btn danger" id="btnDelete">Удалить</button>
          <button type="button" class="btn" id="btnSpend">Списать метры</button>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" value="cancel">Отмена</button>
          <button class="btn btn--accent" id="btnSave" value="default">Сохранить</button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="viewDialog">
    <div class="form">
      <h3 style="margin:0 0 6px;font-size:22px;font-weight:900" id="v_name">—</h3>
      <img id="v_img" class="preview" style="width:100%;height:auto;max-height:280px;object-fit:contain" alt="Фото">
      <div class="field"><label>Количество</label><div id="v_qty">—</div></div>
      <div class="field"><label>Заметка</label><div id="v_note">—</div></div>
      <div class="field"><label>Теги</label><div id="v_tags">—</div></div>
      <div class="bar"><div></div><button class="btn" onclick="document.getElementById('viewDialog').close()">Закрыть</button></div>
    </div>
  </dialog>

<script>
// --- Storage layer -----------------------------------------------------------
const STORAGE_KEY = 'od_data_v1';
const defaultData = { fabrics:[], patterns:[], products:[] };

function loadDB(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || structuredClone(defaultData); }
  catch(e){ console.warn(e); return structuredClone(defaultData); }
}
function saveDB(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

let DB = loadDB();
let currentTab = 'fabrics';
let editingId = null; // for fabrics only in this build

// --- Helpers -----------------------------------------------------------------
const $ = sel => document.querySelector(sel);
function uid(){ return Math.random().toString(36).slice(2,9); }
function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onerror = reject;
    r.onload = ()=> resolve(r.result);
    r.readAsDataURL(file);
  });
}
function fmtQty(v){ return (Number(v)||0).toLocaleString('ru-RU', { maximumFractionDigits: 2 }) + ' м'; }
function toChips(str){
  return (str||'').split(',').map(s=>s.trim()).filter(Boolean);
}

// --- UI: render --------------------------------------------------------------
const listEl = $('#list');
const statTotal = $('#statTotal');
const statSpent = $('#statSpent');

function render(){
  // Stats only for fabrics
  const total = DB.fabrics.reduce((s,f)=>s+(Number(f.qty)||0),0);
  const spent = DB.fabrics.reduce((s,f)=>s+(Number(f.spent)||0),0);
  statTotal.textContent = fmtQty(total);
  statSpent.textContent = fmtQty(spent);

  // controls per tab
  const btnAdd = $('#btnAdd');
  if(currentTab==='fabrics'){ btnAdd.textContent = '+ Добавить ткань'; btnAdd.style.display='inline-block'; }
  else if(currentTab==='patterns'){ btnAdd.textContent = '+ Добавить выкройку'; btnAdd.style.display='inline-block'; }
  else { btnAdd.textContent = '+ Добавить изделие'; btnAdd.style.display='inline-block'; }

  // list
  const q = $('#search').value.trim().toLowerCase();
  listEl.innerHTML='';
  const arr = DB[currentTab];
  if(!arr.length){
    listEl.innerHTML = '<div class="muted" style="opacity:.7">Пока пусто.</div>';
    return;
  }
  const frag = document.createDocumentFragment();
  arr
    .filter(item=>{
      const hay = (item.name+' '+(item.note||'')+' '+(item.tags||'')).toLowerCase();
      return !q || hay.includes(q);
    })
    .forEach(item=>{
      const card = document.createElement('div');
      card.className='card';
      const body = document.createElement('div');
      body.className='card__body';
      const grid = document.createElement('div');
      grid.className='row-split';

      const img = document.createElement('img');
      img.className='thumb';
      img.src = item.photo || '';
      img.alt='';
      grid.appendChild(img);

      const right = document.createElement('div');
      const name = document.createElement('div');
      name.className='name';
      name.textContent=item.name;
      if(currentTab==='fabrics'){
        name.addEventListener('click',()=>openView(item));
      }
      right.appendChild(name);

      if(currentTab==='fabrics'){
        // show note instead of type
        const note = document.createElement('div');
        note.className='muted';
        note.textContent = item.note ? item.note : '—';
        right.appendChild(note);

        const qty = document.createElement('div');
        qty.style.marginTop='6px';
        qty.innerHTML = '<b>Кол-во:</b> '+fmtQty(item.qty||0)+
                        (item.spent? ' &nbsp;&nbsp;<span class="muted">(Списано: '+fmtQty(item.spent)+')</span>' : '');
        right.appendChild(qty);
      }else{
        const meta = document.createElement('div');
        meta.className='muted';
        meta.textContent=item.note||'—';
        right.appendChild(meta);
      }

      const chips = document.createElement('div');
      chips.className='chips';
      toChips(item.tags).forEach(c=>{
        const el=document.createElement('div');el.className='chip';el.textContent=c;chips.appendChild(el);
      });
      right.appendChild(chips);

      const actions=document.createElement('div');
      actions.className='row-actions';

      if(currentTab==='fabrics'){
        const btnEdit=document.createElement('span');
        btnEdit.className='link';
        btnEdit.textContent='Изменить';
        btnEdit.onclick=()=>openEdit(item.id);
        actions.appendChild(btnEdit);

        const btnSpend=document.createElement('span');
        btnSpend.className='link';
        btnSpend.textContent='Списать';
        btnSpend.onclick=()=>spendMeters(item.id);
        actions.appendChild(btnSpend);
      }else{
        const btnEdit=document.createElement('span');
        btnEdit.className='link';
        btnEdit.textContent='Изменить';
        btnEdit.onclick=()=>openEditGeneric(currentTab,item.id);
        actions.appendChild(btnEdit);
      }

      right.appendChild(actions);
      grid.appendChild(right);
      body.appendChild(grid);
      card.appendChild(body);
      frag.appendChild(card);
    });
  listEl.appendChild(frag);
}

function openView(item){
  $('#v_name').textContent=item.name;
  $('#v_img').src=item.photo||'';
  $('#v_qty').textContent=fmtQty(item.qty||0)+(item.spent? ' (списано: '+fmtQty(item.spent)+')':'');
  $('#v_note').textContent=item.note||'—';
  $('#v_tags').textContent=toChips(item.tags).join(', ')||'—';
  $('#viewDialog').showModal();
}

// --- Edit fabric -------------------------------------------------------------
const dlg = $('#editDialog');
const f_name = $('#f_name');
const f_type = $('#f_type');
const f_qty = $('#f_qty');
const f_tags = $('#f_tags');
const f_note = $('#f_note');
const f_file = $('#f_file');
const f_preview = $('#f_preview');

$('#btnClearPhoto').onclick = ()=>{ f_preview.src=''; f_file.value=''; };

f_file.addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const url = await readFileAsDataURL(file);
  f_preview.src = url;
});

function openEdit(id){
  editingId = id || null;
  $('#dlgTitle').textContent = id ? 'Изменить ткань' : 'Добавить ткань';
  $('#dlgHint').textContent = id ? 'Правьте поля и сохраните' : 'Заполните поля и сохраните';
  $('#btnDelete').style.display = id ? 'inline-block' : 'none';
  $('#btnSpend').style.display = id ? 'inline-block' : 'none';
  document.querySelector('[data-for="type"]').style.display = 'grid';

  let obj = {name:'', type:'Хлопок', qty:0, tags:'', note:'', photo:''};
  if(id){
    obj = DB.fabrics.find(f=>f.id===id) || obj;
  }
  f_name.value = obj.name||'';
  f_type.value = obj.type||'Хлопок';
  f_qty.value = obj.qty||0;
  f_tags.value = obj.tags||'';
  f_note.value = obj.note||'';
  f_preview.src = obj.photo||'';

  dlg.showModal();
}

function spendMeters(id){
  const item = DB.fabrics.find(f=>f.id===id);
  if(!item) return;
  let val = prompt('Списать метров (например 0.5):','');
  if(val===null) return;
  val = Number(val);
  if(isNaN(val) || val<0){ alert('Введите число.'); return; }
  if(val>(Number(item.qty)||0)){ if(!confirm('Больше, чем остаток. Все равно списать?')) return; }
  item.qty = Number(item.qty)||0; 
  item.qty = Math.max(0, item.qty - val);
  item.spent = (Number(item.spent)||0) + val;
  saveDB(DB);
  render();
}

$('#btnSave').addEventListener('click', async (e)=>{
  e.preventDefault();
  const data = {
    id: editingId || uid(),
    name: f_name.value.trim(),
    type: f_type.value,
    qty: Number(f_qty.value)||0,
    tags: f_tags.value.trim(),
    note: f_note.value.trim(),
    photo: f_preview.src || ''
  };
  if(!data.name){ alert('Название обязательно'); return; }
  if(editingId){
    const idx = DB.fabrics.findIndex(x=>x.id===editingId);
    if(idx>-1){ DB.fabrics[idx] = {...DB.fabrics[idx], ...data}; }
  }else{
    DB.fabrics.unshift({...data, spent:0});
  }
  saveDB(DB);
  dlg.close();
  render();
});

$('#btnDelete').onclick = ()=>{
  if(!editingId) return;
  if(confirm('Удалить ткань безвозвратно?')){
    DB.fabrics = DB.fabrics.filter(x=>x.id!==editingId);
    saveDB(DB);
    dlg.close();
    render();
  }
};
$('#btnSpend').onclick = ()=>{ if(editingId) spendMeters(editingId); };

// --- Generic add/edit for other tabs (simplified fields) --------------------
function openEditGeneric(tab, id){
  // reuse same dialog but hide "Тип" и "Списать"
  editingId = id || null;
  $('#dlgTitle').textContent = id ? 'Изменить' : 'Добавить';
  $('#dlgHint').textContent = 'Заполните поля и сохраните';
  $('#btnDelete').style.display = id ? 'inline-block' : 'none';
  $('#btnSpend').style.display = 'none';
  document.querySelector('[data-for="type"]').style.display = 'none';

  let obj = {name:'', qty:0, tags:'', note:'', photo:''};
  if(id){ obj = (DB[tab].find(x=>x.id===id)) || obj; }

  f_name.value = obj.name||'';
  f_qty.value = obj.qty||0;
  f_tags.value = obj.tags||'';
  f_note.value = obj.note||'';
  f_preview.src = obj.photo||'';
  dlg.showModal();

  // override save for this open
  const handler = async (e)=>{
    e.preventDefault();
    const data = {
      id: editingId || uid(),
      name: f_name.value.trim(),
      qty: Number(f_qty.value)||0,
      tags: f_tags.value.trim(),
      note: f_note.value.trim(),
      photo: f_preview.src || ''
    };
    if(!data.name){ alert('Название обязательно'); return; }
    if(editingId){
      const idx = DB[tab].findIndex(x=>x.id===editingId);
      if(idx>-1){ DB[tab][idx] = {...DB[tab][idx], ...data}; }
    }else{
      DB[tab].unshift(data);
    }
    saveDB(DB);
    dlg.close();
    render();
    $('#btnSave').removeEventListener('click', handler); // clean
  };
  $('#btnSave').addEventListener('click', handler);
  $('#btnDelete').onclick = ()=>{
    if(!editingId) return;
    if(confirm('Удалить запись?')){
      DB[tab] = DB[tab].filter(x=>x.id!==editingId);
      saveDB(DB); dlg.close(); render();
    }
  };
}

// --- Controls ----------------------------------------------------------------
$('#btnAdd').onclick = ()=>{
  if(currentTab==='fabrics') openEdit();
  else openEditGeneric(currentTab);
};
$('#search').oninput = ()=> render();

document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    currentTab = t.dataset.tab;
    // toggle stats: only for fabrics
    document.getElementById('stats').style.display = currentTab==='fabrics' ? 'flex':'none';
    render();
  });
});

// Export/Import
$('#btnExport').onclick = ()=>{
  const json = JSON.stringify(DB, null, 2);
  const blob = new Blob([json], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'ollys_dream_backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
};
$('#importFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if(!data || typeof data!=='object') throw new Error('bad');
    DB = Object.assign(structuredClone(defaultData), data);
    saveDB(DB);
    alert('Импортировано, страница обновит список.');
    render();
  }catch(err){
    alert('Не удалось импортировать JSON.');
  }finally{ e.target.value=''; }
});

// Initial
render();
</script>
</body>
</html>
